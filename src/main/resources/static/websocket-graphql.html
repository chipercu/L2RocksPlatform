<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script>
    var socket = new WebSocket('ws://' + location.host + '/ws', "graphql-ws");

    socket.onopen = function () {
        console.log("Соединение установлено.");

        // Отправка пакета рукопожатия
        socket.send(JSON.stringify({
            "type": "connection_init"
        }));

        socket.send(JSON.stringify({
            "id": "2",
            "type": "start",
            "payload": {
                "query": "{server{status}}",
                "variables": {}
            }
        }));

        socket.send(JSON.stringify({
            "id": "3",
            "type": "start",
            "payload": {
                "query": "{session{status, employee{id}, uuid}}",
                "variables": {}
            }
        }));


        //Авторизуемся
        socket.send(JSON.stringify({
            "id": "4",
            "type": "start",
            "payload": {
                "query": "mutation Logon($login: String!, $passwordHash: String!){logon(login: $login, password_hash: $passwordHash){status, employee{id}, uuid}}",
                "variables": {
                    "login": "admin",
                    "passwordHash": "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"
                }
            }
        }));
    };

    socket.onclose = function (event) {
        if (event.wasClean) {
            console.log('Соединение закрыто чисто');
        } else {
            console.log('Обрыв соединения'); // например, "убит" процесс сервера
        }
        console.log('Код: ' + event.code + ' причина: ' + event.reason);
    };

    socket.onmessage = function (event) {
        console.log("response: " + event.data);

        if (JSON.parse(event.data).id == "4") {
            //Дожидаемся результат авторизации

            socket.send(JSON.stringify({
                "id": "5",
                "type": "start",
                "payload": {
                    "query": "{session{status, employee{id}, uuid}}",
                    "variables": {}
                }
            }));

            //Заведомо ошибочный пакет
            socket.send(JSON.stringify({
                "id": "6",
                "type": "start",
                "payload": {
                    "query": "{}",
                    "variables": {}
                }
            }));

            //Оформляем подписку
            socket.send(JSON.stringify({
                "id": 7,
                "type": "start",
                "payload": {
                    "query": "subscription{update_active_employee}",
                    "variables": {}
                }
            }));

        }
    };

    socket.onerror = function (error) {
        console.log("Ошибка " + error.message);
    };
</script>
</body>
</html>